{% extends 'crypto_tracker/base.html' %}

{% block title %}{{ coin_id }} - Crypto Tracker{% endblock %}

{% block content %}
<!-- Add the JSON data script tag -->
{{ history_data|json_script:"history-data" }}

<div class="row">
    <!-- Price Information -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-body">
                <h2 class="card-title">{{ coin_id }}</h2>
                {% if price_data %}
                <div class="row">
                    <div class="col-md-6">
                        <h3>${{ price_data.usd|floatformat:10 }}</h3>
                        <p class="{% if price_data.usd_24h_change > 0 %}text-success{% else %}text-danger{% endif %}">
                            24h Change: {{ price_data.usd_24h_change|floatformat:2 }}%
                        </p>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h5>Community Stats</h5>
                                <p class="mb-1">
                                    <i class="bi bi-eye"></i> {{ watchers_count }} watchers
                                </p>
                                <p class="mb-0">
                                    <i class="bi bi-currency-dollar"></i> {{ investment_count }} active investors
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Price Chart -->
        <div class="card mb-4">
            <div class="card-body">
                <h3>Price History</h3>
                <div style="position: relative; width: 100%; height: 400px;">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Investment Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h3>Record Investment</h3>
                <form method="post" action="{% url 'crypto_tracker:add_investment' %}">
                    {% csrf_token %}
                    <input type="hidden" name="coin_symbol" value="{{ coin_id }}">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amount" class="form-label">Amount ({{ coin_id }})</label>
                                <input type="number" step="0.00000001" class="form-control" id="amount" name="amount" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Current Price</label>
                                <input type="text" class="form-control" value="${{ price_data.usd|floatformat:10 }}" readonly>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Record Investment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Watch Entry Form -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h3>Add to Watchlist</h3>
                <form method="post" action="{% url 'crypto_tracker:add_watch_entry' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="coin_symbol" value="{{ coin_id }}">
                    
                    <div class="mb-3">
                        <label for="personal_note" class="form-label">Personal Note</label>
                        <textarea class="form-control" id="personal_note" name="personal_note" rows="3"
                            {% if watch_entry %}placeholder="{{ watch_entry.personal_note }}"{% endif %}></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="image" class="form-label">Market Pattern Screenshot</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*">
                    </div>

                    <button type="submit" class="btn btn-primary">
                        {% if watch_entry %}Update Watchlist{% else %}Add to Watchlist{% endif %}
                    </button>
                </form>
            </div>
        </div>

        <!-- Recent Posts -->
        <div class="card mt-4">
            <div class="card-body">
                <h3>Recent Posts</h3>
                {% for post in recent_posts %}
                <div class="card mb-2">
                    <div class="card-body">
                        <h5 class="card-title">{{ post.title }}</h5>
                        <p class="card-text">{{ post.content|truncatewords:30 }}</p>
                        <small class="text-muted">By {{ post.user.username }} on {{ post.created_at|date:"M d, Y" }}</small>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No posts about this coin yet.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include Chart.js with time scale adapter -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed. Chart script running.');
    
    // Get the canvas element
    const canvas = document.getElementById('priceChart');
    if (!canvas) {
        console.error('Canvas element not found');
        return;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Get the history data
    const historyDataElement = document.getElementById('history-data');
    if (!historyDataElement) {
        console.error('History data element not found');
        document.getElementById('priceChart').parentElement.innerHTML = '<p class="text-muted">No price history data available</p>';
        return;
    }
    
    let historyData;
    try {
        historyData = JSON.parse(historyDataElement.textContent);
        console.log('Parsed historyData:', historyData);
    } catch (error) {
        console.error('Error parsing history data:', error);
        document.getElementById('priceChart').parentElement.innerHTML = '<p class="text-muted">Error parsing price history data</p>';
        return;
    }
    
    // Check if we have valid price data
    if (!historyData || !historyData.prices || !Array.isArray(historyData.prices) || historyData.prices.length === 0) {
        console.log('No valid price data available');
        document.getElementById('priceChart').parentElement.innerHTML = '<p class="text-muted">No price history available</p>';
        return;
    }
    
    console.log('History data available, attempting to draw chart.', historyData.prices.length, 'data points');
    console.log('First data point:', historyData.prices[0]);
    
    // Process the price data
    const prices = historyData.prices.map(function(price, index) {
        if (!Array.isArray(price) || price.length < 2) {
            console.warn('Invalid price data at index', index, ':', price);
            return null;
        }
        return {
            x: new Date(price[0]),
            y: price[1]
        };
    }).filter(price => price !== null);
    
    if (prices.length === 0) {
        console.log('No valid price points after processing');
        document.getElementById('priceChart').parentElement.innerHTML = '<p class="text-muted">No valid price data points</p>';
        return;
    }
    
    console.log('Processed prices:', prices.length, 'valid points');

    try {
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Price (USD)',
                    data: prices,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: false,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Price (USD)'
                        },
                        beginAtZero: false
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Price: $${context.parsed.y.toFixed(10)}`;
                            }
                        }
                    },
                    legend: {
                        display: true
                    }
                }
            }
        });
        
        console.log('Chart created successfully');
        
    } catch (error) {
        console.error('Error initializing Chart.js:', error);
        document.getElementById('priceChart').parentElement.innerHTML = '<p class="text-danger">Error creating price chart: ' + error.message + '</p>';
    }
});
</script>
{% endblock %}